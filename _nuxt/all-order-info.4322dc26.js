import{_ as W}from"./AppProductsGrid.vue.a5656d95.js";import{f as O,r as v,i as U,j as B,o as n,k as l,w as s,q as d,s as q,b as y,n as b,v as X,g as C,S as Y,O as Z,E as ee}from"./entry.8ecf7b66.js";import{A as N}from"./AppCardGroup.bb9690bc.js";import{A as te}from"./AppCardLayout.22fb18ee.js";import ae from"./order-discussion.30964b87.js";import{_ as re}from"./order-form-ro.vue.d07327ec.js";import{_ as oe}from"./AppOrderPublicStatusForm.vue.b0863281.js";import{A as L}from"./AppCard.194ec255.js";import{s as ie}from"./button.esm.bca3ec00.js";import{D as M}from"./datetime.f31b9a37.js";import"./app-grid.vue.65a27604.js";import"./inputnumber.esm.13554fc9.js";import"./inputtext.esm.7a3ec7ea.js";import"./dropdown.esm.8ae7ad21.js";import"./index.esm.bdccc025.js";import"./index.esm.790d43a6.js";import"./overlayeventbus.esm.9b938cd9.js";import"./virtualscroller.esm.2202f42e.js";import"./tristatecheckbox.esm.905cc70e.js";import"./checkbox.esm.9dea44be.js";import"./overlaypanel.esm.fbd3161d.js";import"./index.esm.36f945a1.js";import"./_plugin-vue_export-helper.c27b6911.js";import"./order-discussion-message.cffeda7e.js";const ue=O({__name:"AppOrderCustomerForm",props:{data:{}},setup(t){const a=t,r=v(null),o=v(null);return U(()=>{o.value={displayId:a.data.createdByProfile.displayId,fullName:a.data.createdByProfile.fullName,email:a.data.createdByProfile.userPrivateProfile.email,phoneNumber:a.data.createdByProfile.userPrivateProfile.phoneNumber},r.value=[{$formkit:"primeInputText",name:"displayId",label:"Номер в системе",_disabled:!0},{$formkit:"primeInputText",name:"fullName",label:"Фамилия Имя",_disabled:!0},{$formkit:"primeInputText",name:"email",label:"Email",_disabled:!0},{$formkit:"primeInputText",name:"phoneNumber",label:"Номер телефона",_disabled:!0}]}),(i,e)=>{const w=B("FormKitSchema"),P=B("FormKit");return n(),l(L,{basis:"500px",title:"Заказчик"},{default:s(()=>[d(r)&&d(o)?(n(),l(P,{key:0,ref:"form",modelValue:d(o),"onUpdate:modelValue":e[0]||(e[0]=u=>q(o)?o.value=u:null),type:"form",actions:!1},{default:s(()=>[y(w,{schema:d(r)},null,8,["schema"])]),_:1},8,["modelValue"])):b("",!0)]),_:1})}}});function K(t){if(Number.isFinite(t))return t}function G(t){if(typeof t!="string")return;const a=M.fromFormat(t,"yyyy-MM-dd");if(a.isValid)return a.toJSDate()}function E(t){if(typeof t=="object"&&t instanceof Date){const a=M.fromJSDate(t);if(a.isValid)return a.toFormat("yyyy-MM-dd")}if(typeof t=="string"){const a=M.fromFormat("yyyy-MM-dd",t);if(a.isValid)return a.toFormat("yyyy-MM-dd")}}const se=O({__name:"AppOrderPrivateStatusForm",props:{id:{},readonly:{type:Boolean},data:{}},emits:["update"],setup(t,{emit:a}){const r=t,o=v(null),i=v(null);U(()=>{i.value={deliveryDate:G(r.data.deliveryDate),shippingDate:G(r.data.shippingDate),notes:r.data.notes,totalPriceNet:K(r.data.totalPriceNet),totalPriceGross:K(r.data.totalPriceGross)},o.value=[{$formkit:"primeInputNumber",name:"totalPriceNet",label:"Итого цена нетто",suffix:" PLN",minFractionDigits:2,maxFractionDigits:2,validation:"min:0.01|max:1000000000",_disabled:!0},{$formkit:"primeInputNumber",name:"totalPriceGross",label:"Итого цена брутто",suffix:" PLN",minFractionDigits:2,maxFractionDigits:2,validation:"min:0.01|max:1000000000",_disabled:!0},{$formkit:"primeCalendar",name:"deliveryDate",label:"Дата доставки",dateFormat:"yy-mm-dd",showButtonBar:!0,_disabled:r.readonly},{$formkit:"primeCalendar",name:"shippingDate",label:"Дата выдачи",dateFormat:"yy-mm-dd",showButtonBar:!0,_disabled:r.readonly},{$formkit:"primeTextarea",name:"notes",label:"Заметки",rows:"5",_disabled:r.readonly}]});const e=v(null);function w(){var u;(u=e.value)==null||u.node.submit()}function P(){if(!i.value)return;const{deliveryDate:u,shippingDate:m,notes:T}=i.value;a("update",{deliveryDate:E(u),shippingDate:E(m),notes:T})}return(u,m)=>{const T=B("FormKitSchema"),k=ie,F=B("FormKit");return n(),l(L,{basis:"500px",title:"Учёт заказа #"+r.id},{default:s(()=>[d(o)&&d(i)?(n(),l(F,{key:0,ref_key:"form",ref:e,modelValue:d(i),"onUpdate:modelValue":m[1]||(m[1]=$=>q(i)?i.value=$:null),type:"form",actions:!1,onSubmit:P},{default:s(()=>[y(T,{schema:d(o)},null,8,["schema"]),r.readonly?b("",!0):(n(),l(k,{key:0,label:"Обновить",onClick:m[0]||(m[0]=()=>w())}))]),_:1},8,["modelValue"])):b("",!0)]),_:1},8,["title"])}}}),$e=O({__name:"all-order-info",setup(t){const o=X().query.orderId,i=Number(Array.isArray(o)?o[0]:o),e=v(null),w=v(void 0),P=v(null),u=v(null),m=C(Y),T=C(Z);async function k(){e.value=null,w.value=void 0,P.value=null,u.value=null}async function F(){k();const c=(await T.getAllOrders(i))[0];e.value=c;const{id:p,vatDocumentRequired:f,shippingMethodName:S,comment:_,orderStatusTypeId:h,productsPriceToPay:I,totalPriceToPay:x,shippingPriceToPay:g,deliveryDate:A,shippingDate:V,notes:z,totalPriceNet:H,totalPriceGross:Q}=c;w.value={id:p,vatDocumentRequired:f,shippingMethodName:S,comment:_},P.value={orderStatusTypeId:h,productsPriceToPay:I,totalPriceToPay:x,shippingPriceToPay:g},u.value={deliveryDate:A,shippingDate:V,notes:z,totalPriceNet:H,totalPriceGross:Q}}const $=C(ee);U(F);async function R(D){if(!e.value)return;const c=e.value.createdByProfile.userPrivateProfile.email,p=e.value.orderStatusTypeId,{id:f,orderPrivateStatus:S,orderPublicStatus:_}=e.value,{orderStatusTypeId:h,shippingPriceToPay:I,orderStatusTypeName:x}=D;k(),await m.set(async g=>g.rpc("updateOrderStatus",{orderId:f,newTypeId:h,newPublicStatus:{shippingPriceToPay:I},newProductsPublicStatus:_.productsPublicStatus,newPrivateStatus:S.privateStatus,newProductsPrivateStatus:S.productsPrivateStatus})),p!==h&&await $.sendStatusEmail(c,f,x),await F()}async function j(D){if(!e.value)return;const{id:c,orderPrivateStatus:p,orderPublicStatus:f,orderStatusTypeId:S}=e.value;k(),await m.set(async _=>_.rpc("updateOrderStatus",{orderId:c,newTypeId:S,newPublicStatus:f.publicStatus,newProductsPublicStatus:f.productsPublicStatus,newPrivateStatus:D,newProductsPrivateStatus:p.productsPrivateStatus})),await F()}async function J(D){if(!e.value)return;const{id:c,orderPrivateStatus:p,orderPublicStatus:f,orderStatusTypeId:S}=e.value,_=[],h=[];for(const I of D){const{priceToPay:x,priceGross:g,priceMarkup:A,priceNet:V}=I;_.push({priceToPay:x}),h.push({priceGross:g,priceMarkup:A,priceNet:V})}k(),await m.set(async I=>I.rpc("updateOrderStatus",{orderId:c,newTypeId:S,newPublicStatus:f.publicStatus,newProductsPublicStatus:_,newPrivateStatus:p.privateStatus,newProductsPrivateStatus:h})),await F()}return(D,c)=>{const p=W;return n(),l(te,null,{default:s(()=>[y(N,null,{default:s(()=>[e.value?(n(),l(p,{key:0,items:e.value.products,mode:"moder",onUpdated:J},null,8,["items"])):b("",!0)]),_:1}),y(N,null,{default:s(()=>[y(re,{data:w.value},null,8,["data"])]),_:1}),y(N,null,{default:s(()=>[P.value?(n(),l(oe,{key:0,id:d(i),data:P.value,readonly:!1,onUpdate:R},null,8,["id","data"])):b("",!0)]),_:1}),y(N,null,{default:s(()=>[u.value?(n(),l(se,{key:0,id:d(i),data:u.value,readonly:!1,onUpdate:j},null,8,["id","data"])):b("",!0)]),_:1}),y(N,null,{default:s(()=>[e.value?(n(),l(ue,{key:0,data:e.value},null,8,["data"])):b("",!0)]),_:1}),y(N,null,{default:s(()=>[e.value?(n(),l(ae,{key:0,customerEmail:e.value.createdByProfile.userPrivateProfile.email,"order-id":d(i),mode:"moder"},null,8,["customerEmail","order-id"])):b("",!0)]),_:1})]),_:1})}}});export{$e as default};
