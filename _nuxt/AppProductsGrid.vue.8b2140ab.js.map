{"version":3,"file":"AppProductsGrid.vue.8b2140ab.js","sources":["../../../../src/components/grid/app-form-grid.vue","../../../../src/components/grid/link-preset.tsx","../../../../src/components/app/AppProductsGrid.vue"],"sourcesContent":["<template>\r\n  <AppGrid\r\n    :data=\"props.data\"\r\n    :config=\"config\"\r\n  />\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport {\r\n  AppGrid,\r\n  AppGridConfig,\r\n  AppFormGridConfig,\r\n  validationOutcomePreset,\r\n} from '@/components/grid';\r\n\r\nconst props = defineProps<{data: any[]; config: AppFormGridConfig<any>}>();\r\n\r\nconst config: AppGridConfig<any> = {\r\n  title: props.config.title,\r\n  basis: props.config.basis,\r\n  allowUpdate: props.config.allowUpdate,\r\n  allowAdd: () => {\r\n    props.data.push(\r\n      (props.config.newItemFunc ?? (() => ({})))(props.data.length),\r\n    );\r\n  },\r\n  allowDelete: item => {\r\n    const index = props.data.findIndex(\r\n      x => x[props.config.dataKey] === item[props.config.dataKey],\r\n    );\r\n\r\n    if (index !== -1) {\r\n      props.data.splice(index, 1);\r\n    }\r\n\r\n    props.config.onDeleted?.call(undefined, item);\r\n  },\r\n  allowEdit: true,\r\n  props: {\r\n    dataKey: props.config.dataKey,\r\n    editMode: 'cell',\r\n    filterDisplay: undefined,\r\n  },\r\n  emits: {\r\n    'cell-edit-complete': e => (props.data[e.index][e.field] = e.newValue),\r\n  },\r\n  getData: () => Promise.resolve(props.data),\r\n  hidePaging: true,\r\n  labels: props.config.labels,\r\n  columns: {\r\n    $validationOutcome: validationOutcomePreset(props.config.validationFunc),\r\n    ...props.config.columns,\r\n  },\r\n};\r\n</script>\r\n","import {ColumnConfig} from './configuration';\r\nimport {defaultPreset, plainGridEditor} from './presets';\r\n\r\nfunction shortenLink(link: string, maxLength: number) {\r\n  if (link.length <= maxLength) {\r\n    return link; // No need to shorten\r\n  }\r\n\r\n  const baseUrl = link.split('?')[0];\r\n  const ellipsis = '...';\r\n  const availableSpace = maxLength - ellipsis.length;\r\n  const informativePart = baseUrl.substr(-availableSpace);\r\n  const shortenedLink = ellipsis + informativePart;\r\n\r\n  return shortenedLink;\r\n}\r\n\r\nexport function linkColumnPresetNoEdit(maxLength: number): ColumnConfig {\r\n  return {\r\n    ...defaultPreset,\r\n    slots: {\r\n      body: ({data, field}) => {\r\n        const link = data[field];\r\n\r\n        if (!link) {\r\n          return [];\r\n        }\r\n\r\n        const label = shortenLink(link, maxLength);\r\n\r\n        return [\r\n          <a target=\"_blank\" style=\"text-decoration: underline;\" href={link}>\r\n            {label}\r\n          </a>,\r\n        ];\r\n      },\r\n    },\r\n  };\r\n}\r\n\r\nexport function linkColumnPreset(maxLength: number): ColumnConfig {\r\n  const src = linkColumnPresetNoEdit(maxLength);\r\n  return {\r\n    ...src,\r\n    slots: {\r\n      ...src.slots,\r\n      body: ({data, field}) => {\r\n        const link = data[field];\r\n\r\n        if (!link) {\r\n          return [];\r\n        }\r\n\r\n        const label = shortenLink(link, maxLength);\r\n\r\n        return [\r\n          <span>{label}</span>,\r\n          <a\r\n            target=\"_blank\"\r\n            style=\"text-decoration: underline; margin-left: 5px\"\r\n            href={link}\r\n          >\r\n            <i class=\"pi pi-play\" />\r\n          </a>,\r\n        ];\r\n      },\r\n      editor: plainGridEditor,\r\n    },\r\n  };\r\n}\r\n","<template>\r\n  <AppFormGrid\r\n    :config=\"config\"\r\n    :data=\"props.items\"\r\n  />\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport {\r\n  AppFormGrid,\r\n  AppFormGridConfig,\r\n  stringColumnPresetNoEdit,\r\n  integerColumnPreset,\r\n  currencyColumnPresetNoEdit,\r\n  currencyColumnPreset,\r\n} from '@/components/grid';\r\nimport {\r\n  linkColumnPreset,\r\n  linkColumnPresetNoEdit,\r\n} from '@/components/grid/link-preset';\r\nimport {ModerProduct, Product} from '@/services/order-list.service';\r\n\r\ntype GridMode = 'new' | 'moder' | 'moder-ro' | 'user-ro';\r\n\r\nconst emit = defineEmits<{\r\n  (event: 'update', data: ModerProduct[]): void;\r\n}>();\r\n\r\nconst props = defineProps<{\r\n  items: Array<Product & {id: number}>;\r\n  mode: GridMode;\r\n}>();\r\n\r\nfunction adjustIndexes() {\r\n  for (let i = 0; i < props.items?.length; i++) {\r\n    (props.items[i] as any).id = i + 1;\r\n  }\r\n}\r\n\r\nconst config: AppFormGridConfig<ModerProduct & {id: number}> = {\r\n  basis: '500px',\r\n  title: 'Товары от одного продавца',\r\n  dataKey: 'id',\r\n  allowUpdate:\r\n    props.mode === 'moder'\r\n      ? () => emit('update', props.items as any)\r\n      : undefined,\r\n  allowAdd: props.mode === 'new',\r\n  allowEdit: props.mode === 'new' || props.mode === 'moder',\r\n  allowDelete: props.mode === 'new',\r\n  onDeleted: () => adjustIndexes(),\r\n  newItemFunc: currentLength => ({id: currentLength + 1, count: 1}),\r\n  validationFunc: productValidationFunc,\r\n  labels: {\r\n    id: '#',\r\n    url: 'Ссылка',\r\n    count: 'Количество',\r\n    priceToPay: 'К оплате',\r\n    priceNet: 'Цена нетто',\r\n    priceGross: 'Цена брутто',\r\n    priceMarkup: 'Наценка',\r\n  },\r\n  columns: {\r\n    id: stringColumnPresetNoEdit,\r\n    url:\r\n      props.mode === 'new' ? linkColumnPreset(50) : linkColumnPresetNoEdit(50),\r\n    count:\r\n      props.mode === 'new' ? integerColumnPreset : stringColumnPresetNoEdit,\r\n    priceToPay: buildUserCurrency(props.mode),\r\n    priceNet: buildModerCurrency(props.mode),\r\n    priceGross: buildModerCurrency(props.mode),\r\n    priceMarkup: buildModerCurrency(props.mode),\r\n  },\r\n};\r\n\r\nfunction buildUserCurrency(mode: GridMode) {\r\n  if (mode === 'new') {\r\n    return false;\r\n  }\r\n\r\n  if (mode === 'moder') {\r\n    return currencyColumnPreset;\r\n  }\r\n\r\n  return currencyColumnPresetNoEdit;\r\n}\r\n\r\nfunction buildModerCurrency(mode: GridMode) {\r\n  if (mode === 'moder') {\r\n    return currencyColumnPreset;\r\n  }\r\n\r\n  if (mode === 'moder-ro') {\r\n    return currencyColumnPresetNoEdit;\r\n  }\r\n\r\n  return false;\r\n}\r\n</script>\r\n\r\n<script lang=\"ts\">\r\nexport function productValidationFunc(value: Partial<ModerProduct>) {\r\n  const result = [] as string[];\r\n\r\n  if (!Number.isFinite(value.count) || value.count! < 1) {\r\n    result.push('Количество должно быть больше либо равно 1');\r\n  }\r\n\r\n  if (!value.url || !validateURL(value.url)) {\r\n    result.push(\r\n      'Укажите ссылку на товар в формате https://site.com/some-product',\r\n    );\r\n  } else if (value.url.length > 65536) {\r\n    result.push('Максимальная длинна ссылки 65536');\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nfunction validateURL(url: string): boolean {\r\n  const regex =\r\n    /^(https?):\\/\\/(([^:\\/?#\\s]+)(?::(\\d+))?)(\\/[^?#\\s]*)?(\\?[^#\\s]*)?(#\\S*)?$/i;\r\n  return regex.test(url);\r\n}\r\n</script>\r\n"],"names":["config","props","item","index","x","_a","e","validationOutcomePreset","shortenLink","link","maxLength","length","baseUrl","split","ellipsis","availableSpace","informativePart","substr","linkColumnPresetNoEdit","defaultPreset","slots","body","data","field","label","_createVNode","linkColumnPreset","src","editor","plainGridEditor","productValidationFunc","value","result","validateURL","url","adjustIndexes","i","emit","currentLength","stringColumnPresetNoEdit","integerColumnPreset","buildUserCurrency","buildModerCurrency","mode","currencyColumnPreset","currencyColumnPresetNoEdit"],"mappings":"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"}