{"version":3,"file":"new-order.9675006a.js","sources":["../../../../src/pages/user/new-order.vue"],"sourcesContent":["<script setup lang=\"ts\">\r\nimport {ref} from 'vue';\r\nimport NewOrderForm from './components/new-order-form.vue';\r\nimport {FormKitNode} from '@formkit/core';\r\nimport {FormKit} from '@formkit/vue';\r\nimport AppCardLayout from '@/components/markup/AppCardLayout.vue';\r\nimport {SupabaseService} from '@/services/supabase.service';\r\nimport {productValidationFunc} from '@/components/app/AppProductsGrid.vue';\r\n\r\nconst router = useRouter();\r\nconst supabase = useService(SupabaseService);\r\nconst form = ref(null as null | {node: FormKitNode});\r\n\r\nconst data = ref({\r\n  comment: '',\r\n  products: [{id: 1, url: '', count: 1}],\r\n  shippingMethodId: null,\r\n  vatDocumentRequired: false,\r\n});\r\n\r\nasync function onValidSubmit(value: any) {\r\n  const item = {\r\n    ...value,\r\n    products: value.products.map((x: any) => ({url: x.url, count: x.count})),\r\n  };\r\n\r\n  const data = await supabase.set(async x => x.rpc('addOrder', item));\r\n\r\n  if (data?.id) {\r\n    router.push('/user/my-order-info?orderId=' + data?.id);\r\n  }\r\n}\r\n\r\nfunction atLeastOneProduct(node: FormKitNode) {\r\n  const value = node.value as typeof data.value;\r\n\r\n  return value.products.length > 0;\r\n}\r\n\r\nfunction validProducts(node: FormKitNode) {\r\n  const value = node.value as typeof data.value;\r\n\r\n  return !value.products\r\n    .map(productValidationFunc)\r\n    .some((x: any[]) => x.length);\r\n}\r\n\r\nfunction onSubmit() {\r\n  form.value?.node.submit();\r\n}\r\n</script>\r\n\r\n<template>\r\n  <FormKit\r\n    ref=\"form\"\r\n    v-model=\"data\"\r\n    type=\"form\"\r\n    validation=\"atLeastOneProduct|validProducts\"\r\n    :validation-rules=\"{atLeastOneProduct, validProducts}\"\r\n    :validation-messages=\"{\r\n      atLeastOneProduct: 'Добавьте хотя бы один товар.',\r\n      validProducts: 'Заполните корректно таблицу с товарами',\r\n    }\"\r\n    :actions=\"false\"\r\n    @submit=\"onValidSubmit\"\r\n  >\r\n    <AppCardLayout>\r\n      <NewOrderForm\r\n        :msg-source=\"form?.node\"\r\n        @submit=\"onSubmit\"\r\n      />\r\n    </AppCardLayout>\r\n  </FormKit>\r\n</template>\r\n"],"names":["router","useRouter","supabase","useService","SupabaseService","form","ref","data","onValidSubmit","value","item","x","atLeastOneProduct","node","validProducts","productValidationFunc","onSubmit","_a"],"mappings":"i7BASA,MAAMA,EAASC,IACTC,EAAWC,EAAWC,CAAe,EACrCC,EAAOC,EAAI,IAAkC,EAE7CC,EAAOD,EAAI,CACf,QAAS,GACT,SAAU,CAAC,CAAC,GAAI,EAAG,IAAK,GAAI,MAAO,EAAE,EACrC,iBAAkB,KAClB,oBAAqB,EAAA,CACtB,EAED,eAAeE,EAAcC,EAAY,CACvC,MAAMC,EAAO,CACX,GAAGD,EACH,SAAUA,EAAM,SAAS,IAAKE,IAAY,CAAC,IAAKA,EAAE,IAAK,MAAOA,EAAE,KAAO,EAAA,CAAA,EAGnEJ,EAAO,MAAML,EAAS,IAAI,MAAMS,GAAKA,EAAE,IAAI,WAAYD,CAAI,CAAC,EAE9DH,GAAAA,MAAAA,EAAM,IACDP,EAAA,KAAK,gCAAiCO,GAAAA,YAAAA,EAAM,GAAE,CAEzD,CAEA,SAASK,EAAkBC,EAAmB,CAGrC,OAFOA,EAAK,MAEN,SAAS,OAAS,CACjC,CAEA,SAASC,EAAcD,EAAmB,CAGjC,MAAA,CAFOA,EAAK,MAEL,SACX,IAAIE,CAAqB,EACzB,KAAMJ,GAAaA,EAAE,MAAM,CAChC,CAEA,SAASK,GAAW,QACbC,EAAAZ,EAAA,QAAA,MAAAY,EAAO,KAAK,QACnB"}